# 变体的AES实验报告
汪乐平 2021210920
## AES实现
除S盒之外，其余部分并未要求进行改动，因此均按照AES官方版本实现。
### 状态存储
为方便实现，均使用$4*4$的unsigned char数组存储状态。
### AddRoundKey
依据轮数$round$，下标$i$和$j$与对应的轮密钥进行异或。
### SubBytes与InvSubBytes
为追求效率，存储S盒及其逆置换，使用查表法对状态进行代换。
### ShiftRows与InvShiftRows
依据行下标对第$1$至$3$行使用不同的轮换（第$0$行不变）。
### MixColumns与InvMixColumns
为追求效率，预先存储所有可能使用的结果，使用查表法计算列混合。
### 轮密钥生成
轮密钥生成包含在AES类的构造函数中。构造时依据AES类型（AES128，AES192或AES256）生成对应的轮密钥。
### Enc与Dec
将$16$字节的输入转换成$4*4$的unsigned char数组，依据AES类型执行若干轮加/解密过程，最后再转换回$16$字节的输出。
## S盒研究
### S盒构造
S盒代换的第一步是对一个$8$次不可约多项式求逆。$F_2$上所有次数是$4$的因子的不可约多项式的积是$x^{2^4}-x=x^{16}-x$，$F_2$上所有次数是$8$的因子的不可约多项式的积是$x^{2^8}-x=x^{256}-x$。因此$F_2$上所有次数是$8$的不可约多项式的积是$\frac{x^{256}-x}{x^{16}-x}$，次数为$256-16=240$，共有$\frac{240}{8}=30$个$8$次不可约多项式。枚举并检验所有$8$次多项式，确实找到了恰好$30$个不可约多项式。AES官方版本的S盒使用的是对应的二进制数最小的不可约多项式。

第二步是做一次可逆的线性变换。这里只使用了与官方版本类似的线性变换，即若干个$rotl(x,k)(0\le k<8)$（$rotl$为循环左移）的异或。对每个$k$有取与不取两种选择，共有$2^8=256$中变换，其中可逆的为取奇数个$k$的$128$种。AES官方版本的S盒选取的$k$为$\{0,1,2,3,4\}$。

第三步为与一个常数进行异或，共有$256$种。AES官方版本的S盒选取的常数为$0\mathrm{x}63$。

本实验中研究的S盒即为这$30*128*256=983040$个。
### S盒的差分分布表
由于$(x\oplus c)\oplus(y\oplus c)=x\oplus y$，因此第三步选取的常数对差分分布表没有任何影响。由于第二步是线性变换，因此只会改变行内各个数字的顺序，不会改变分布。因此只需要研究$30$个S盒的差分分布表即可。

经计算，所有照上文所述方式生成的S盒的差分分布表均是等价的。除第$0$行外每行均有$129$个$0$，$126$个$2$和$1$个$4$。因此可认为这些S盒抗差分攻击的效果是相同的。
### S盒的线性近似表
由于没有想到能利用的性质，因此对全部的$983040$个S盒，均计算了一遍线性近似表，求出其中每个值的出现次数。

经计算，所有照上文所述方式生成的S盒的线性近似表，任何一个数字在除第三步取常数为$0$的$3840$个之外的每一个线性近似表中的出现次数都是相等的。如果对线性近似表中的数字取绝对值，则任何一个数字在每一个线性近似表中的出现次数都是相等的。除第$0$行第$0$列的$128$之外，绝对值最大为$16$，共有$1275$个。因此可认为这些S盒抗线性攻击的效果是相同的。
### 选取的S盒
程序中选取的S盒的第一步与第二步均与官方版本相同，第三步选取的常数为$0\mathrm{x}15$，这样能使得S盒是一个长度为$256$的轮换。具体的S盒取值可见aes.cpp。
## 不同模式的性能
### 测试环境
测试在本机进行，CPU为Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz。测试时开启-Ofast和-march=native选项。
### 模式实现
CBC模式按照标准实现。

CFB模式使用__uint128_t类型变量保存移位寄存器。对$r$为$8$的倍数（即以字节为单位）的情况进行了优化。其余部分按照标准实现。

CTR模式使用__uint128_t类型变量保存计数器。其余部分按照标准实现。
### 测试结果
下表为不同模式的加解密速度，单位为Mbps，保留到整数。

|模式|Enc|Dec|
|-|-|-|
|CBC|320|284|
|CFB(8bits)|19|20|
|CFB(16bits)|38|38|
|CFB(32bits)|75|75|
|CFB(64bits)|142|140|
|CFB(128bits)|250|250|
|CTR|310|310|
## 文件简述
### aes.cpp与aes.h
类AES的定义与实现。支持三种不同类型（AES128，AES192与AES256）的AES加密与解密。
### gen.cpp
用于生成AES中MixColumns与InvMixColumns函数所需的表。
### main.cpp
性能测试的主文件。
### sbox.cpp
生成与测试S盒。
### service.cpp与service.h
三种模式（CBC，CFB，CTR）对应的Service类及其基类的定义与实现。